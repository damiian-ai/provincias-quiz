<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
const width = 900, height = 1200;
const DEFAULT_URL = "https://apis.datos.gob.ar/georef/api/provincias?formato=geojson";

let status = {};
let selectedId = null;
let selectedName = "";
let score = 0;

const msgEl = d3.select("#message");
const scoreEl = d3.select("#score");
const guessEl = document.getElementById("guess");

const svg = d3.select("#map").append("svg")
  .attr("viewBox", [0, 0, width, height]);
const g = svg.append("g");

const projection = d3.geoMercator()
  .center([-64, -40])
  .scale(1300)
  .translate([width/2, height/1.5]);
const path = d3.geoPath().projection(projection);

const zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", (ev)=>{
  g.attr("transform", ev.transform);
});
svg.call(zoom).on("dblclick.zoom", null);

function fillFor(d){
  const id = d.id;
  const st = status[id];
  if (st === "ok")  return "rgba(34,197,94,0.85)";
  if (st === "bad") return "rgba(239,68,68,0.70)";
  if (id === selectedId) return "rgba(147,197,253,0.55)";
  return "transparent";
}
function repaint(){ g.selectAll("path").attr("fill", fillFor); }

fetch(DEFAULT_URL)
  .then(r => r.json())
  .then(data => {
    const features = data.features;

    // Dibuja las provincias (sin círculos)
    g.selectAll("path")
      .data(features, d => d.id)
      .join("path")
      .attr("d", path)
      .attr("fill", fillFor)
      .attr("stroke", "#1e293b")
      .attr("stroke-width", 2)
      .style("cursor", "pointer")
      .on("click", (_ev, d) => {
        selectedId   = d.id;
        selectedName = d.properties?.nombre || "";
        msgEl.text(`Provincia seleccionada`);
        repaint();
        guessEl.focus();
      });

    // BORRAR cualquier círculo por si quedó alguno
    g.selectAll("circle").remove();
  });

document.getElementById("zoomIn").onclick   = () => svg.transition().call(zoom.scaleBy, 1.5);
document.getElementById("zoomOut").onclick  = () => svg.transition().call(zoom.scaleBy, 0.7);
document.getElementById("resetZoom").onclick= () => svg.transition().call(zoom.scaleTo, 1);

document.getElementById("check").onclick = () => {
  if (!selectedId) { msgEl.text("Tocá una provincia primero."); guessEl.focus(); return; }
  const val = guessEl.value.trim().toLowerCase();
  const ok  = val === selectedName.toLowerCase();

  const prev = status[selectedId];
  status[selectedId] = ok ? "ok" : "bad";
  if (ok && prev !== "ok") { score++; }
  scoreEl.text(score);

  msgEl.text(ok ? `✅ Correcto` : "❌ Incorrecto");
  guessEl.value = "";
  guessEl.focus();
  repaint();
};

document.getElementById("reset").onclick = () => {
  status = {}; selectedId = null; selectedName = ""; score = 0;
  scoreEl.text(0); msgEl.text(""); guessEl.value = "";
  repaint();
  svg.transition().call(zoom.scaleTo, 1);
};

guessEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") { e.preventDefault(); document.getElementById("check").click(); }
});
</script>